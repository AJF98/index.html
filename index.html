<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Jigsaw Challenge</title>
  <!-- Open Graph meta tags for social sharing -->
  <meta property="og:title" content="Daily Jigsaw Challenge" />
  <meta property="og:description" content="A daily jigsaw puzzle for everyone. New puzzle every day!" />
  <meta property="og:type" content="website" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary-color: #3f51b5;
      --accent-color: #ff4081;
      --success-color: #4caf50;
      --background-color: #f5f7fa;
      --container-bg: #ffffff;
      --text-color: #333333;
      --border-radius: 12px;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      padding: 20px;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .container {
      max-width: 800px;
      width: 100%;
    }
    header {
      margin-bottom: 20px;
    }
    h1 {
      margin-bottom: 10px;
      font-weight: 700;
      color: var(--primary-color);
    }
    .subheader {
      font-size: 0.9rem;
      margin-bottom: 15px;
      color: #666;
    }
    .game-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .stat-box {
      background-color: var(--container-bg);
      padding: 10px 15px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-width: 100px;
    }
    .stat-box h3 {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-box p {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
    }
    .timer {
      color: var(--primary-color);
      font-weight: 600;
    }
    .countdown {
      color: var(--text-color);
      font-size: 0.9rem;
    }
    .hint-container {
      margin-bottom: 15px;
      position: relative;
      width: 120px;
      margin: 0 auto 15px;
    }
    #reference-image {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .hint-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 120px;
      height: 120px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    /* Puzzle container styling */
    #puzzle-container {
      margin: 0 auto;
      position: relative;
      border: 2px solid #ccc;
      border-radius: var(--border-radius);
      background: var(--container-bg);
      box-shadow: var(--shadow);
      overflow: hidden;
      touch-action: none;
    }
    /* Each puzzle piece */
    canvas.piece {
      position: absolute;
      cursor: grab;
      transition: transform 0.2s ease;
      touch-action: none;
    }
    canvas.piece:hover {
      transform: scale(1.03);
      z-index: 10;
    }
    canvas.dragging {
      opacity: 0.8;
      cursor: grabbing;
      z-index: 100;
      transition: none;
    }
    canvas.correct {
      box-shadow: 0 0 8px var(--success-color);
    }
    #message {
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--success-color);
      min-height: 30px;
    }
    /* Leaderboard styling */
    #leaderboardContainer {
      margin-top: 20px;
      text-align: left;
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 30px;
    }
    #leaderboardContainer h3 {
      text-align: center;
      margin-bottom: 10px;
      color: var(--primary-color);
    }
    #leaderboardContainer table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: var(--border-radius);
      overflow: hidden;
    }
    #leaderboardContainer th, #leaderboardContainer td {
      padding: 12px 8px;
      border-bottom: 1px solid #eee;
    }
    #leaderboardContainer th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }
    #leaderboardContainer tr:nth-child(even) {
      background-color: rgba(0,0,0,0.02);
    }
    #leaderboardContainer tr:last-child td {
      border-bottom: none;
    }
    #leaderboardContainer tr.highlight {
      background-color: rgba(63, 81, 181, 0.1);
      font-weight: 600;
    }
    /* Confetti */
    #confetti-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 200;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      opacity: 0.9;
      animation: confettiFall 3s linear forwards;
    }
    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(500px) rotate(720deg);
        opacity: 0;
      }
    }
    /* Completion Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: var(--container-bg);
      padding: 30px;
      border-radius: var(--border-radius);
      text-align: center;
      max-width: 90%;
      width: 400px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .modal h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    .modal p {
      margin-bottom: 20px;
    }
    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background-color: #303f9f;
    }
    .share-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
      margin: 15px 0;
    }
    .share-cell {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 4px;
    }
    .share-cell.correct {
      background-color: var(--success-color);
    }
    .share-cell.incorrect {
      background-color: #ccc;
    }
    .share-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      background-color: #f9f9f9;
    }
    .share-emoji-grid {
      font-size: 1.2rem;
      margin: 10px 0;
      letter-spacing: 2px;
    }
    /* Profile Area */
    .profile-area {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 15px;
      width: 100%;
    }
    .profile-btn {
      background: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }
    /* Streak indicator */
    .streak-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      margin: 10px 0;
    }
    .streak-flame {
      color: #ff9800;
      font-size: 1.2rem;
    }
    .streak-count {
      font-weight: 600;
      color: var(--primary-color);
    }
    /* Stats Modal */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 15px 0;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    .stat-label {
      font-size: 0.8rem;
      color: #666;
    }
    /* Dark mode toggle */
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 1.5rem;
    }
    /* Login Modal */
    #loginModal .modal-content {
      max-width: 400px;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    /* Timer flash animation */
    @keyframes timerFlash {
      0% { color: var(--primary-color); }
      50% { color: var(--accent-color); }
      100% { color: var(--primary-color); }
    }
    .timer-flash {
      animation: timerFlash 1s infinite;
    }
    /* Dark theme */
    body.dark-theme {
      --primary-color: #7986cb;
      --accent-color: #ff80ab;
      --success-color: #81c784;
      --background-color: #121212;
      --container-bg: #1e1e1e;
      --text-color: #ffffff;
    }
    body.dark-theme .share-container {
      background-color: #2a2a2a;
      border-color: #333;
    }
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .game-stats {
        flex-direction: column;
        align-items: center;
      }
      .stat-box {
        width: 100%;
        max-width: 300px;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="theme-toggle" id="themeToggle">🌙</div>
  <div class="container">
    <header>
      <h1>Daily Jigsaw Challenge</h1>
      <div class="subheader">#<span id="puzzleNumber">1</span> - <span id="todayDate">March 8, 2025</span></div>
    </header>
    
    <div class="profile-area">
      <div id="userProfileArea">
        <!-- If not logged in, a Sign In button will appear -->
      </div>
    </div>
    
    <div class="game-stats">
      <div class="stat-box">
        <h3>TIME</h3>
        <p id="timer">00:00</p>
      </div>
      <div class="stat-box">
        <h3>YOUR BEST</h3>
        <p id="bestTime">--:--</p>
      </div>
      <div class="stat-box">
        <h3>NEXT PUZZLE</h3>
        <p id="countdown">--:--:--</p>
      </div>
    </div>

    <div class="streak-indicator" id="streakIndicator" style="display: none;">
      <span class="streak-flame">🔥</span>
      <span class="streak-count" id="streakCount">0</span>
      <span>day streak!</span>
    </div>

    <!-- Hint: Reference image -->
    <div class="hint-container">
      <img id="reference-image" alt="Reference puzzle" />
      <div class="hint-overlay" id="hintOverlay">Click for hint</div>
    </div>

    <!-- Puzzle container -->
    <div id="puzzle-container">
      <div id="confetti-container"></div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboardContainer"></div>

    <!-- Completion message -->
    <div id="message"></div>
  </div>

  <!-- Completion Modal -->
  <div id="completionModal" class="modal">
    <div class="modal-content">
      <h2>Puzzle Completed!</h2>
      <p id="completionMessage">
        You solved today's puzzle in <span id="completionTime">0:00</span>!
      </p>
      
      <div class="streak-indicator" id="modalStreakIndicator" style="display: none;">
        <span class="streak-flame">🔥</span>
        <span class="streak-count" id="modalStreakCount">0</span>
        <span>day streak!</span>
      </div>
      
      <div class="share-container">
        <p>Daily Jigsaw #<span id="shareNumber">1</span> - <span id="completionTime2">0:00</span></p>
        <div class="share-emoji-grid" id="shareEmoji">🟩🟩🟩🟩<br>🟩🟩🟩🟩<br>🟩🟩🟩🟩<br>🟩🟩🟩🟩</div>
        <p>jigsawchallenge.com</p>
      </div>
      
      <button id="shareButton" class="btn">Share Result</button>
      <button id="statsButton" class="btn">View Stats</button>
      <button id="closeModalButton" class="btn">Close</button>
    </div>
  </div>
  
  <!-- Stats Modal -->
  <div id="statsModal" class="modal">
    <div class="modal-content">
      <h2>Your Statistics</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number" id="statPlayed">0</div>
          <div class="stat-label">Played</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="statWinPercent">0%</div>
          <div class="stat-label">Win %</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="statCurrentStreak">0</div>
          <div class="stat-label">Current Streak</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="statMaxStreak">0</div>
          <div class="stat-label">Max Streak</div>
        </div>
      </div>
      <h3>Time Distribution</h3>
      <div id="timeDistribution" style="margin: 15px 0;">
        <!-- Chart or details can be added here -->
      </div>
      <h3>Best Times</h3>
      <div id="bestTimes" style="margin: 15px 0;">
        <!-- Best times list -->
      </div>
      <button id="closeStatsButton" class="btn">Close</button>
    </div>
  </div>
  
  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Sign In</h2>
      <p>Sign in to track your stats and appear on the leaderboard!</p>
      <div id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Enter your email" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" />
        </div>
        <button id="signInButton" class="btn">Sign In</button>
        <button id="signUpButton" class="btn">Sign Up</button>
      </div>
      <div id="loginError" style="color: red; margin-top: 10px; display: none;"></div>
      <p style="margin-top: 15px;"><a href="#" id="forgotPassword">Forgot password?</a></p>
      <button id="closeLoginButton" class="btn">Cancel</button>
    </div>
  </div>

  <script>
    // -------------------------------------------------------------
    // Firebase Initialization (Replace with your Firebase config)
    // -------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // -------------------------------------------------------------
    // THEME SWITCHER
    // -------------------------------------------------------------
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      themeToggle.textContent = document.body.classList.contains('dark-theme') ? '☀️' : '🌙';
      localStorage.setItem('jigsawTheme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
    });
    if (localStorage.getItem('jigsawTheme') === 'dark') {
      document.body.classList.add('dark-theme');
      themeToggle.textContent = '☀️';
    }

    // -------------------------------------------------------------
    // DOM ELEMENTS
    // -------------------------------------------------------------
    const container = document.getElementById("puzzle-container");
    const timerDisplay = document.getElementById("timer");
    const bestTimeDisplay = document.getElementById("bestTime");
    const countdownDisplay = document.getElementById("countdown");
    const referenceImage = document.getElementById("reference-image");
    const hintOverlay = document.getElementById("hintOverlay");
    const messageDisplay = document.getElementById("message");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const puzzleNumberDisplay = document.getElementById("puzzleNumber");
    const todayDateDisplay = document.getElementById("todayDate");
    const userProfileArea = document.getElementById("userProfileArea");
    const streakIndicator = document.getElementById("streakIndicator");
    const streakCount = document.getElementById("streakCount");

    // Completion Modal elements
    const completionModal = document.getElementById("completionModal");
    const closeModalButton = document.getElementById("closeModalButton");
    const shareButton = document.getElementById("shareButton");
    const statsButton = document.getElementById("statsButton");
    const completionTimeSpan = document.getElementById("completionTime");
    const completionTimeSpan2 = document.getElementById("completionTime2");
    const shareNumberSpan = document.getElementById("shareNumber");
    const modalStreakIndicator = document.getElementById("modalStreakIndicator");
    const modalStreakCount = document.getElementById("modalStreakCount");

    // Stats Modal elements
    const statsModal = document.getElementById("statsModal");
    const closeStatsButton = document.getElementById("closeStatsButton");
    const statPlayed = document.getElementById("statPlayed");
    const statWinPercent = document.getElementById("statWinPercent");
    const statCurrentStreak = document.getElementById("statCurrentStreak");
    const statMaxStreak = document.getElementById("statMaxStreak");
    const timeDistribution = document.getElementById("timeDistribution");
    const bestTimes = document.getElementById("bestTimes");

    // Login Modal elements
    const loginModal = document.getElementById("loginModal");
    const closeLoginButton = document.getElementById("closeLoginButton");
    const signInButton = document.getElementById("signInButton");
    const signUpButton = document.getElementById("signUpButton");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginError = document.getElementById("loginError");
    const forgotPassword = document.getElementById("forgotPassword");

    // -------------------------------------------------------------
    // DAILY SEED, PUZZLE NUMBER & COUNTDOWN
    // -------------------------------------------------------------
    const todayDate = new Date();
    const todayStr = todayDate.toISOString().split('T')[0];
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    todayDateDisplay.textContent = todayDate.toLocaleDateString(undefined, options);
    const startDate = new Date('2025-01-01');
    const diffTime = Math.abs(todayDate - startDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    puzzleNumberDisplay.textContent = diffDays;
    shareNumberSpan.textContent = diffDays;
    let seed = 0;
    for (let i = 0; i < todayStr.length; i++) {
      seed += todayStr.charCodeAt(i);
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    const random = mulberry32(seed);
    function updateCountdown() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(0, 0, 0, 0);
      const diff = tomorrow - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);
      countdownDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes
        .toString()
        .padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // -------------------------------------------------------------
    // TIMER FUNCTIONS
    // -------------------------------------------------------------
    let startTime = Date.now();
    let elapsedTime = 0;
    let timerInterval;
    const timerKey = "jigsawPuzzleTimer-" + todayStr;
    const bestTimeKey = "jigsawBestTime-" + todayStr;
    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return (
        minutes.toString().padStart(2, '0') +
        ":" +
        seconds.toString().padStart(2, '0')
      );
    }
    function startTimer() {
      const savedElapsed = localStorage.getItem(timerKey);
      if (savedElapsed) {
        elapsedTime = parseInt(savedElapsed, 10);
        startTime = Date.now() - elapsedTime;
      }
      const bestTime = localStorage.getItem(bestTimeKey);
      if (bestTime) {
        bestTimeDisplay.textContent = formatTime(parseInt(bestTime, 10));
      }
      timerInterval = setInterval(() => {
        elapsedTime = Date.now() - startTime;
        timerDisplay.textContent = formatTime(elapsedTime);
        localStorage.setItem(timerKey, elapsedTime.toString());
      }, 1000);
      timerDisplay.textContent = formatTime(elapsedTime);
    }
    function stopTimer() {
      clearInterval(timerInterval);
    }

    // -------------------------------------------------------------
    // PUZZLE IMAGE GENERATION (Fixed 4×4 for Daily Puzzle)
    // -------------------------------------------------------------
    function getDifficultySettings() {
      const rows = 4, cols = 4;
      let baseSize = 400;
      let bumpSize = 20;
      if (window.innerWidth < 480) {
        baseSize = 300;
        bumpSize = 15;
      }
      const pieceWidth = baseSize / cols;
      const pieceHeight = baseSize / rows;
      const containerSize = baseSize + 2 * bumpSize;
      container.style.width = containerSize + "px";
      container.style.height = containerSize + "px";
      return { rows, cols, baseSize, bumpSize, pieceWidth, pieceHeight, containerSize };
    }
    function generateBaseImage() {
      const { baseSize } = getDifficultySettings();
      const canvas = document.createElement("canvas");
      canvas.width = baseSize;
      canvas.height = baseSize;
      const ctx = canvas.getContext("2d");
      const grad = ctx.createLinearGradient(0, 0, baseSize, baseSize);
      const color1 = `hsl(${Math.floor(random()*360)}, 70%, 70%)`;
      const color2 = `hsl(${Math.floor(random()*360)}, 70%, 70%)`;
      grad.addColorStop(0, color1);
      grad.addColorStop(1, color2);
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, baseSize, baseSize);
      const patternType = Math.floor(random() * 4);
      if (patternType === 0) {
        for (let i = 0; i < 15; i++) {
          ctx.beginPath();
          const x = random() * baseSize;
          const y = random() * baseSize;
          const radius = random() * 50 + 20;
          ctx.arc(x, y, radius, 0, 2 * Math.PI);
          ctx.fillStyle = `hsla(${Math.floor(random()*360)}, 70%, 50%, 0.6)`;
          ctx.fill();
        }
      } else if (patternType === 1) {
        const stripeCount = Math.floor(random() * 10) + 5;
        const stripeWidth = baseSize / stripeCount;
        for (let i = 0; i < stripeCount; i++) {
          ctx.fillStyle = `hsla(${Math.floor(random()*360)}, 70%, 50%, 0.6)`;
          ctx.fillRect(i * stripeWidth, 0, stripeWidth, baseSize);
        }
      } else if (patternType === 2) {
        const gridSize = Math.floor(random() * 5) + 3;
        const cellSize = baseSize / gridSize;
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if ((i + j) % 2 === 0) {
              ctx.fillStyle = `hsla(${Math.floor(random()*360)}, 70%, 50%, 0.6)`;
              ctx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
            }
          }
        }
      } else {
        for (let i = 0; i < 8; i++) {
          ctx.beginPath();
          ctx.moveTo(random() * baseSize, random() * baseSize);
          ctx.bezierCurveTo(
            random() * baseSize, random() * baseSize,
            random() * baseSize, random() * baseSize,
            random() * baseSize, random() * baseSize
          );
          ctx.closePath();
          ctx.fillStyle = `hsla(${Math.floor(random()*360)}, 70%, 50%, 0.6)`;
          ctx.fill();
        }
      }
      return canvas;
    }

    // -------------------------------------------------------------
    // JIGSAW PIECE CREATION
    // -------------------------------------------------------------
    function createPuzzlePieces(baseImageCanvas) {
      const { rows, cols, baseSize, bumpSize, pieceWidth, pieceHeight } = getDifficultySettings();
      const pieces = [];
      const piecesArray = [];
      for (let r = 0; r < rows; r++) {
        pieces[r] = [];
        for (let c = 0; c < cols; c++) {
          const piece = {
            row: r,
            col: c,
            currentRow: r,
            currentCol: c,
            edges: {},
            locked: false
          };
          piece.edges.top = (r === 0) ? 0 : -pieces[r-1][c].edges.bottom;
          piece.edges.left = (c === 0) ? 0 : -pieces[r][c-1].edges.right;
          piece.edges.right = (c === cols - 1) ? 0 : (random() > 0.5 ? 1 : -1);
          piece.edges.bottom = (r === rows - 1) ? 0 : (random() > 0.5 ? 1 : -1);
          pieces[r][c] = piece;
        }
      }
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const piece = pieces[r][c];
          const offCanvas = document.createElement("canvas");
          offCanvas.width = pieceWidth + 2 * bumpSize;
          offCanvas.height = pieceHeight + 2 * bumpSize;
          const offCtx = offCanvas.getContext("2d");
          offCtx.save();
          offCtx.translate(bumpSize, bumpSize);
          drawJigsawShape(offCtx, piece.edges, pieceWidth, pieceHeight, bumpSize);
          offCtx.clip();
          offCtx.drawImage(
            baseImageCanvas,
            c * pieceWidth, r * pieceHeight,
            pieceWidth, pieceHeight,
            0, 0,
            pieceWidth, pieceHeight
          );
          offCtx.restore();
          const domCanvas = document.createElement("canvas");
          domCanvas.width = offCanvas.width;
          domCanvas.height = offCanvas.height;
          domCanvas.className = "piece";
          const domCtx = domCanvas.getContext("2d");
          domCtx.drawImage(offCanvas, 0, 0);
          piece.canvas = domCanvas;
          piecesArray.push(piece);
          container.appendChild(domCanvas);
        }
      }
      return { pieces, piecesArray };
    }
    function drawJigsawShape(ctx, edges, w, h, bump) {
      ctx.beginPath();
      const topThird = w / 3;
      ctx.moveTo(0, 0);
      ctx.lineTo(topThird, 0);
      if (edges.top !== 0) {
        ctx.bezierCurveTo(
          topThird + topThird/4, edges.top * bump,
          2 * topThird - topThird/4, edges.top * bump,
          2 * topThird, 0
        );
      }
      ctx.lineTo(w, 0);
      const rightThird = h / 3;
      ctx.lineTo(w, rightThird);
      if (edges.right !== 0) {
        ctx.bezierCurveTo(
          w + edges.right * bump, rightThird + rightThird/4,
          w + edges.right * bump, 2 * rightThird - rightThird/4,
          w, 2 * rightThird
        );
      }
      ctx.lineTo(w, h);
      const bottomThird = w / 3;
      ctx.lineTo(w - bottomThird, h);
      if (edges.bottom !== 0) {
        ctx.bezierCurveTo(
          w - bottomThird - bottomThird/4, h + edges.bottom * bump,
          bottomThird + bottomThird/4, h + edges.bottom * bump,
          bottomThird, h
        );
      }
      ctx.lineTo(0, h);
      const leftThird = h / 3;
      ctx.lineTo(0, h - leftThird);
      if (edges.left !== 0) {
        ctx.bezierCurveTo(
          edges.left * bump, h - leftThird - leftThird/4,
          edges.left * bump, leftThird + leftThird/4,
          0, leftThird
        );
      }
      ctx.lineTo(0, 0);
      ctx.closePath();
    }

    // -------------------------------------------------------------
    // PUZZLE STATE MANAGEMENT (Daily Puzzle)
    // -------------------------------------------------------------
    function scramblePieces(piecesArray) {
      const { rows, cols, pieceWidth, pieceHeight, bumpSize } = getDifficultySettings();
      const stateKey = "jigsawPuzzleState-" + todayStr;
      let savedState = localStorage.getItem(stateKey);
      if (savedState) {
        const positions = JSON.parse(savedState);
        positions.forEach((pos, i) => {
          if (i < piecesArray.length) {
            piecesArray[i].currentRow = pos.currentRow;
            piecesArray[i].currentCol = pos.currentCol;
          }
        });
      } else {
        const positions = [];
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            positions.push({ row: r, col: c });
          }
        }
        for (let i = positions.length - 1; i > 0; i--) {
          const j = Math.floor(random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        piecesArray.forEach((piece, index) => {
          if (index < positions.length) {
            piece.currentRow = positions[index].row;
            piece.currentCol = positions[index].col;
          }
        });
        savePuzzleState(piecesArray);
      }
      piecesArray.forEach(piece => {
        positionPiece(piece, pieceWidth, pieceHeight, bumpSize);
        updatePieceHighlight(piece);
      });
    }
    function positionPiece(piece, pieceWidth, pieceHeight, bumpSize) {
      piece.canvas.style.left = (piece.currentCol * pieceWidth - bumpSize) + "px";
      piece.canvas.style.top = (piece.currentRow * pieceHeight - bumpSize) + "px";
    }
    function updatePieceHighlight(piece) {
      if (piece.currentRow === piece.row && piece.currentCol === piece.col) {
        piece.canvas.classList.add("correct");
        piece.locked = true;
      } else {
        piece.canvas.classList.remove("correct");
        piece.locked = false;
      }
    }
    function savePuzzleState(piecesArray) {
      const stateKey = "jigsawPuzzleState-" + todayStr;
      const positions = piecesArray.map(piece => ({
        currentRow: piece.currentRow,
        currentCol: piece.currentCol
      }));
      localStorage.setItem(stateKey, JSON.stringify(positions));
    }

    // -------------------------------------------------------------
    // DRAG-AND-DROP LOGIC
    // -------------------------------------------------------------
    function addDragAndDrop(piecesArray) {
      const { rows, cols, pieceWidth, pieceHeight, bumpSize } = getDifficultySettings();
      piecesArray.forEach(piece => {
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        piece.canvas.addEventListener("pointerdown", (e) => {
          if (piece.locked) return;
          isDragging = true;
          piece.canvas.classList.add("dragging");
          piece.canvas.setPointerCapture(e.pointerId);
          const rect = piece.canvas.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
        });
        piece.canvas.addEventListener("pointermove", (e) => {
          if (!isDragging) return;
          const containerRect = container.getBoundingClientRect();
          const newLeft = e.clientX - containerRect.left - offsetX;
          const newTop = e.clientY - containerRect.top - offsetY;
          piece.canvas.style.left = newLeft + "px";
          piece.canvas.style.top = newTop + "px";
        });
        piece.canvas.addEventListener("pointerup", (e) => {
          if (!isDragging) return;
          isDragging = false;
          piece.canvas.classList.remove("dragging");
          const leftPos = parseInt(piece.canvas.style.left, 10);
          const topPos = parseInt(piece.canvas.style.top, 10);
          let targetCol = Math.round((leftPos + bumpSize) / pieceWidth);
          let targetRow = Math.round((topPos + bumpSize) / pieceHeight);
          targetCol = Math.max(0, Math.min(cols - 1, targetCol));
          targetRow = Math.max(0, Math.min(rows - 1, targetRow));
          const other = piecesArray.find(p =>
            p !== piece &&
            p.currentRow === targetRow &&
            p.currentCol === targetCol
          );
          if (other) {
            const tmpRow = piece.currentRow;
            const tmpCol = piece.currentCol;
            piece.currentRow = other.currentRow;
            piece.currentCol = other.currentCol;
            other.currentRow = tmpRow;
            other.currentCol = tmpCol;
            positionPiece(piece, pieceWidth, pieceHeight, bumpSize);
            positionPiece(other, pieceWidth, pieceHeight, bumpSize);
            updatePieceHighlight(piece);
            updatePieceHighlight(other);
          } else {
            piece.currentRow = targetRow;
            piece.currentCol = targetCol;
            positionPiece(piece, pieceWidth, pieceHeight, bumpSize);
            updatePieceHighlight(piece);
          }
          savePuzzleState(piecesArray);
          if (checkPuzzleSolved(piecesArray)) {
            puzzleComplete();
          }
        });
      });
    }
    function checkPuzzleSolved(piecesArray) {
      return piecesArray.every(p => p.currentRow === p.row && p.currentCol === p.col);
    }

    // -------------------------------------------------------------
    // PUZZLE COMPLETE & LEADERBOARD SUBMISSION
    // -------------------------------------------------------------
    function puzzleComplete() {
      stopTimer();
      const totalTime = elapsedTime;
      const bestTime = localStorage.getItem(bestTimeKey);
      if (!bestTime || parseInt(bestTime, 10) > totalTime) {
        localStorage.setItem(bestTimeKey, totalTime.toString());
        bestTimeDisplay.textContent = formatTime(totalTime);
      }
      completionTimeSpan.textContent = formatTime(totalTime);
      completionTimeSpan2.textContent = formatTime(totalTime);
      if (bestTime && parseInt(bestTime, 10) < totalTime) {
        modalBestTimeSpan.textContent = formatTime(parseInt(bestTime, 10));
      } else {
        modalBestTimeSpan.textContent = formatTime(totalTime);
      }
      completionModal.style.display = "flex";
      launchConfetti();
      submitScore(totalTime);
      if (currentUser) {
        updateUserStats(totalTime);
      }
    }
    function submitScore(score) {
      const todayDoc = todayStr;
      db.collection("leaderboard")
        .doc(todayDoc)
        .collection("scores")
        .add({
          score: score,
          uid: currentUser ? currentUser.uid : null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          console.log("Score submitted.");
          loadLeaderboard();
        })
        .catch((error) => {
          console.error("Error submitting score:", error);
        });
    }
    function loadLeaderboard() {
      const todayDoc = todayStr;
      db.collection("leaderboard")
        .doc(todayDoc)
        .collection("scores")
        .orderBy("score", "asc")
        .limit(10)
        .get()
        .then((querySnapshot) => {
          let leaderboardHTML = "<h3>Daily Leaderboard</h3><table><tr><th>Rank</th><th>Time</th></tr>";
          let rank = 1;
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            leaderboardHTML += `<tr><td>${rank}</td><td>${formatTime(data.score)}</td></tr>`;
            rank++;
          });
          leaderboardHTML += "</table>";
          leaderboardContainer.innerHTML = leaderboardHTML;
        })
        .catch((error) => {
          console.error("Error loading leaderboard:", error);
        });
    }
    function launchConfetti() {
      const colors = ["#FFC107", "#E91E63", "#03A9F4", "#4CAF50", "#FF5722"];
      const confettiCount = 50;
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement("div");
        confetti.className = "confetti";
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * container.offsetWidth + "px";
        document.getElementById("confetti-container").appendChild(confetti);
        confetti.addEventListener("animationend", () => {
          confetti.parentNode.removeChild(confetti);
        });
      }
    }

    // -------------------------------------------------------------
    // USER AUTHENTICATION & PROFILE
    // -------------------------------------------------------------
    let currentUser = null;
    function setupAuthUI() {
      if (auth.currentUser) {
        currentUser = auth.currentUser;
        const displayName = currentUser.displayName || currentUser.email.split('@')[0];
        const initials = displayName.substring(0, 2).toUpperCase();
        userProfileArea.innerHTML = `
          <div class="user-profile">
            <div class="user-avatar">${initials}</div>
            <span>${displayName}</span>
            <button id="signOutButton" class="profile-btn">Sign Out</button>
          </div>
        `;
        document.getElementById("signOutButton").addEventListener("click", () => {
          auth.signOut().then(setupAuthUI);
        });
        loadUserStats();
      } else {
        userProfileArea.innerHTML = `<button id="loginButton" class="profile-btn">Sign In</button>`;
        document.getElementById("loginButton").addEventListener("click", () => {
          loginModal.style.display = "flex";
        });
      }
    }
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      setupAuthUI();
    });
    // Load user statistics
    function loadUserStats() {
      if (!currentUser) return;
      db.collection("users").doc(currentUser.uid).get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          statPlayed.textContent = data.played || 0;
          statWinPercent.textContent = data.winPercent ? data.winPercent + "%" : "0%";
          statCurrentStreak.textContent = data.currentStreak || 0;
          statMaxStreak.textContent = data.maxStreak || 0;
          if (data.currentStreak > 0) {
            streakIndicator.style.display = "flex";
            streakCount.textContent = data.currentStreak;
          } else {
            streakIndicator.style.display = "none";
          }
        } else {
          statPlayed.textContent = "0";
          statWinPercent.textContent = "0%";
          statCurrentStreak.textContent = "0";
          statMaxStreak.textContent = "0";
          streakIndicator.style.display = "none";
        }
      }).catch((error) => {
        console.error("Error loading user stats:", error);
      });
    }
    // Update user statistics after a win
    function updateUserStats(totalTime) {
      if (!currentUser) return;
      const userRef = db.collection("users").doc(currentUser.uid);
      userRef.get().then((doc) => {
        let played = 0, wins = 0, currentStreak = 0, maxStreak = 0;
        if (doc.exists) {
          const data = doc.data();
          played = data.played || 0;
          wins = data.wins || 0;
          currentStreak = data.currentStreak || 0;
          maxStreak = data.maxStreak || 0;
        }
        played++;
        wins++;
        currentStreak++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;
        const winPercent = Math.round((wins / played) * 100);
        userRef.set({
          played: played,
          wins: wins,
          currentStreak: currentStreak,
          maxStreak: maxStreak,
          winPercent: winPercent,
          lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(() => {
          loadUserStats();
        }).catch((error) => {
          console.error("Error updating user stats:", error);
        });
      }).catch((error) => {
        console.error("Error reading user stats:", error);
      });
    }
    // -------------------------------------------------------------
    // LOGIN MODAL FUNCTIONALITY
    // -------------------------------------------------------------
    signInButton.addEventListener("click", () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password.";
        loginError.style.display = "block";
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          loginModal.style.display = "none";
          emailInput.value = "";
          passwordInput.value = "";
          loginError.style.display = "none";
        })
        .catch((error) => {
          loginError.textContent = error.message;
          loginError.style.display = "block";
        });
    });
    signUpButton.addEventListener("click", () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      if (!email || !password) {
        loginError.textContent = "Please enter both email and password.";
        loginError.style.display = "block";
        return;
      }
      if (password.length < 6) {
        loginError.textContent = "Password should be at least 6 characters long.";
        loginError.style.display = "block";
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          loginModal.style.display = "none";
          emailInput.value = "";
          passwordInput.value = "";
          loginError.style.display = "none";
        })
        .catch((error) => {
          loginError.textContent = error.message;
          loginError.style.display = "block";
        });
    });
    closeLoginButton.addEventListener("click", () => {
      loginModal.style.display = "none";
      loginError.style.display = "none";
    });
    forgotPassword.addEventListener("click", (e) => {
      e.preventDefault();
      const email = emailInput.value;
      if (!email) {
        loginError.textContent = "Please enter your email address.";
        loginError.style.display = "block";
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          loginError.textContent = "Password reset email sent! Check your inbox.";
          loginError.style.display = "block";
        })
        .catch((error) => {
          loginError.textContent = error.message;
          loginError.style.display = "block";
        });
    });

    // -------------------------------------------------------------
    // MODAL & SHARE FUNCTIONALITY
    // -------------------------------------------------------------
    closeModalButton.addEventListener("click", () => {
      completionModal.style.display = "none";
      loadLeaderboard();
    });
    shareButton.addEventListener("click", () => {
      const totalTime = formatTime(elapsedTime);
      const shareText = `I solved today's jigsaw puzzle in ${totalTime}! Can you beat my time?`;
      if (navigator.share) {
        navigator.share({ text: shareText });
      } else {
        navigator.clipboard.writeText(shareText);
        alert("Result copied to clipboard!");
      }
    });
    statsButton.addEventListener("click", () => {
      statsModal.style.display = "flex";
    });
    closeStatsButton.addEventListener("click", () => {
      statsModal.style.display = "none";
    });

    // -------------------------------------------------------------
    // HINT FUNCTIONALITY
    // -------------------------------------------------------------
    let hintVisible = false;
    hintOverlay.addEventListener("click", () => {
      hintVisible = !hintVisible;
      hintOverlay.style.opacity = hintVisible ? "0" : "1";
    });

    // -------------------------------------------------------------
    // LEADERBOARD FUNCTIONS (Firebase Firestore)
    // -------------------------------------------------------------
    function submitScore(score) {
      const todayDoc = todayStr;
      db.collection("leaderboard")
        .doc(todayDoc)
        .collection("scores")
        .add({
          score: score,
          uid: currentUser ? currentUser.uid : null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          console.log("Score submitted.");
          loadLeaderboard();
        })
        .catch((error) => {
          console.error("Error submitting score:", error);
        });
    }
    function loadLeaderboard() {
      const todayDoc = todayStr;
      db.collection("leaderboard")
        .doc(todayDoc)
        .collection("scores")
        .orderBy("score", "asc")
        .limit(10)
        .get()
        .then((querySnapshot) => {
          let leaderboardHTML = "<h3>Daily Leaderboard</h3><table><tr><th>Rank</th><th>Time</th></tr>";
          let rank = 1;
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            leaderboardHTML += `<tr><td>${rank}</td><td>${formatTime(data.score)}</td></tr>`;
            rank++;
          });
          leaderboardHTML += "</table>";
          leaderboardContainer.innerHTML = leaderboardHTML;
        })
        .catch((error) => {
          console.error("Error loading leaderboard:", error);
        });
    }

    // -------------------------------------------------------------
    // INITIALIZE PUZZLE
    // -------------------------------------------------------------
    function initPuzzle() {
      startTimer();
      const baseImageCanvas = generateBaseImage();
      referenceImage.src = baseImageCanvas.toDataURL();
      const { pieces, piecesArray } = createPuzzlePieces(baseImageCanvas);
      scramblePieces(piecesArray);
      addDragAndDrop(piecesArray);
    }
    window.onload = () => {
      initPuzzle();
    };

    // -------------------------------------------------------------
    // USER STATISTICS FUNCTIONS
    // -------------------------------------------------------------
    function loadUserStats() {
      if (!currentUser) return;
      db.collection("users").doc(currentUser.uid).get().then((doc) => {
        if (doc.exists) {
          const data = doc.data();
          statPlayed.textContent = data.played || 0;
          statWinPercent.textContent = data.winPercent ? data.winPercent + "%" : "0%";
          statCurrentStreak.textContent = data.currentStreak || 0;
          statMaxStreak.textContent = data.maxStreak || 0;
          if (data.currentStreak > 0) {
            streakIndicator.style.display = "flex";
            streakCount.textContent = data.currentStreak;
          } else {
            streakIndicator.style.display = "none";
          }
        } else {
          statPlayed.textContent = "0";
          statWinPercent.textContent = "0%";
          statCurrentStreak.textContent = "0";
          statMaxStreak.textContent = "0";
          streakIndicator.style.display = "none";
        }
      }).catch((error) => {
        console.error("Error loading user stats:", error);
      });
    }
    function updateUserStats(totalTime) {
      if (!currentUser) return;
      const userRef = db.collection("users").doc(currentUser.uid);
      userRef.get().then((doc) => {
        let played = 0, wins = 0, currentStreak = 0, maxStreak = 0;
        if (doc.exists) {
          const data = doc.data();
          played = data.played || 0;
          wins = data.wins || 0;
          currentStreak = data.currentStreak || 0;
          maxStreak = data.maxStreak || 0;
        }
        played++;
        wins++;
        currentStreak++;
        if (currentStreak > maxStreak) maxStreak = currentStreak;
        const winPercent = Math.round((wins / played) * 100);
        userRef.set({
          played: played,
          wins: wins,
          currentStreak: currentStreak,
          maxStreak: maxStreak,
          winPercent: winPercent,
          lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true }).then(() => {
          loadUserStats();
        }).catch((error) => {
          console.error("Error updating user stats:", error);
        });
      }).catch((error) => {
        console.error("Error reading user stats:", error);
      });
    }

  </script>
</body>
</html>
